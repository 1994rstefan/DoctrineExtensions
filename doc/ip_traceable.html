<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctrine Extensions 3.0.0</title>

    <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic'
          rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="http://Atlantic18.github.io/DoctrineExtensions/css/theme.css" type="text/css"/>
    <link rel="stylesheet" href="http://Atlantic18.github.io/DoctrineExtensions/css/theme-fixes.css" type="text/css"/>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/github.min.css">
</head>
<body class="wy-body-for-nav">

    <div class="wy-grid-for-nav">

        <nav data-toggle="wy-nav-shift" class="wy-nav-side">
            <div class="wy-side-nav-search">
                <a href="http://Atlantic18.github.io/DoctrineExtensions/" class="fa fa-home"> Doctrine Extensions 3.0.0</a>
            </div>

            <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                                            <li class="toctree-l1 ">
                            <a class="reference internal "
                               href="http://Atlantic18.github.io/DoctrineExtensions/doc/tree.html">
                                Tree
                            </a>
                        </li>
                                            <li class="toctree-l1 ">
                            <a class="reference internal "
                               href="http://Atlantic18.github.io/DoctrineExtensions/doc/translatable.html">
                                Translatable
                            </a>
                        </li>
                                            <li class="toctree-l1 ">
                            <a class="reference internal "
                               href="http://Atlantic18.github.io/DoctrineExtensions/doc/sluggable.html">
                                Sluggable
                            </a>
                        </li>
                                            <li class="toctree-l1 ">
                            <a class="reference internal "
                               href="http://Atlantic18.github.io/DoctrineExtensions/doc/timestampable.html">
                                Timestampable
                            </a>
                        </li>
                                            <li class="toctree-l1 ">
                            <a class="reference internal "
                               href="http://Atlantic18.github.io/DoctrineExtensions/doc/blameable.html">
                                Blameable
                            </a>
                        </li>
                                            <li class="toctree-l1 ">
                            <a class="reference internal "
                               href="http://Atlantic18.github.io/DoctrineExtensions/doc/loggable.html">
                                Loggable
                            </a>
                        </li>
                                            <li class="toctree-l1 ">
                            <a class="reference internal "
                               href="http://Atlantic18.github.io/DoctrineExtensions/doc/sortable.html">
                                Sortable
                            </a>
                        </li>
                                            <li class="toctree-l1 ">
                            <a class="reference internal "
                               href="http://Atlantic18.github.io/DoctrineExtensions/doc/translatable.html">
                                Translator
                            </a>
                        </li>
                                            <li class="toctree-l1 ">
                            <a class="reference internal "
                               href="http://Atlantic18.github.io/DoctrineExtensions/doc/softdeleteable.html">
                                SoftDeleteable
                            </a>
                        </li>
                                            <li class="toctree-l1 ">
                            <a class="reference internal "
                               href="http://Atlantic18.github.io/DoctrineExtensions/doc/uploadable.html">
                                Uploadable
                            </a>
                        </li>
                                            <li class="toctree-l1 ">
                            <a class="reference internal "
                               href="http://Atlantic18.github.io/DoctrineExtensions/doc/references.html">
                                References
                            </a>
                        </li>
                                            <li class="toctree-l1 ">
                            <a class="reference internal "
                               href="http://Atlantic18.github.io/DoctrineExtensions/doc/reference_integrity.html">
                                ReferenceIntegrity
                            </a>
                        </li>
                                            <li class="toctree-l1 ">
                            <a class="reference internal "
                               href="http://Atlantic18.github.io/DoctrineExtensions/doc/ip_traceable.html">
                                IpTraceable
                            </a>
                        </li>
                                    </ul>
            </div>
            &nbsp;
        </nav>

        <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

                        <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
                <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
                <a href="http://Atlantic18.github.io/DoctrineExtensions/">Doctrine Extensions 3.0.0</a>
            </nav>


                        <div class="wy-nav-content">
                <div class="rst-content">
                    <div role="main" class="document">
                        <h1 id="iptraceable-behavior-extension-for-doctrine-2">IpTraceable behavior extension for Doctrine 2</h1>
<p><strong>IpTraceable</strong> behavior will automate the update of IP trace
on your Entities or Documents. It works through annotations and can update
fields on creation, update, property subset update, or even on specific property value change.</p>
<p>This is very similar to Timestampable but sets a string.</p>
<p>Note that you need to set the IP on the IpTraceableListener (unless you use the
Symfony2 extension which does automatically assign the current request IP).</p>
<p>Features:</p>
<ul>
<li>Automatic predefined ip field update on creation, update, property subset update, and even on record property changes</li>
<li>ORM and ODM support using same listener</li>
<li>Specific annotations for properties, and no interface required</li>
<li>Can react to specific property or relation changes to specific value</li>
<li>Can be nested with other behaviors</li>
<li>Annotation, Yaml and Xml mapping support for extensions</li>
</ul>
<p><strong>Symfony:</strong></p>
<ul>
<li><strong>IpTraceable</strong> is not yet available as <a href="http://github.com/stof/StofDoctrineExtensionsBundle">Bundle</a>
for <strong>Symfony2</strong>, together with all other extensions</li>
</ul>
<p>This article will cover the basic installation and functionality of <strong>IpTraceable</strong> behavior</p>
<p>Content:</p>
<ul>
<li><a href="#including-extension">Including</a> the extension</li>
<li>Entity <a href="#entity-mapping">example</a></li>
<li>Document <a href="#document-mapping">example</a></li>
<li><a href="#yaml-mapping">Yaml</a> mapping example</li>
<li><a href="#xml-mapping">Xml</a> mapping example</li>
<li>Advanced usage <a href="#advanced-examples">examples</a></li>
<li>Using <a href="#traits">Traits</a></li>
</ul>
<p><a name="including-extension"></a></p>
<h2 id="setup-and-autoloading">Setup and autoloading</h2>
<p>Read the <a href="http://github.com/l3pp4rd/DoctrineExtensions/blob/master/doc/annotations.html#em-setup">documentation</a>
or check the <a href="http://github.com/l3pp4rd/DoctrineExtensions/tree/master/example">example code</a>
on how to setup and use the extensions in most optimized way.</p>
<p><a name="entity-mapping"></a></p>
<h2 id="iptraceable-entity-example">IpTraceable Entity example:</h2>
<h3 id="iptraceable-annotations">IpTraceable annotations:</h3>
<ul>
<li><strong>@Gedmo\Mapping\Annotation\IpTraceable</strong> this annotation tells that this column is ipTraceable
by default it updates this column on update. If column is not a string field it will trigger an exception.</li>
</ul>
<p>Available configuration options:</p>
<ul>
<li><strong>on</strong> - is main option and can be <strong>create, update, change</strong> this tells when it
should be updated</li>
<li><strong>field</strong> - only valid if <strong>on=&quot;change&quot;</strong> is specified, tracks property or a list of properties for changes</li>
<li><strong>value</strong> - only valid if <strong>on=&quot;change&quot;</strong> is specified and the tracked field is a single field (not an array), if the tracked field has this <strong>value</strong>
then it updates the trace</li>
</ul>
<p><strong>Note:</strong> that IpTraceable interface is not necessary, except in cases there
you need to identify entity as being IpTraceable. The metadata is loaded only once then
cache is activated</p>
<p>Column is a string field:</p>
<pre><code class="language-php">&lt;?php
namespace Entity;

use Gedmo\Mapping\Annotation as Gedmo;
use Doctrine\ORM\Mapping as ORM;

/**
 * @ORM\Entity
 */
class Article
{
    /** @ORM\Id @ORM\GeneratedValue @ORM\Column(type="integer") */
    private $id;

    /**
     * @ORM\Column(length=128)
     */
    private $title;

    /**
     * @ORM\Column
     */
    private $body;

    /**
     * @var string $createdFromIp
     *
     * @Gedmo\IpTraceable(on="create")
     * @ORM\Column(length=45, nullable=true)
     */
    private $createdFromIp;

    /**
     * @var string $updatedFromIp
     *
     * @Gedmo\IpTraceable(on="update")
     * @ORM\Column(length=45, nullable=true)
     */
    private $updatedFromIp;

    /**
     * @var datetime $contentChangedFromIp
     *
     * @ORM\Column(nullable=true, length=45)
     * @Gedmo\IpTraceable(on="change", field={"title", "body"})
     */
    private $contentChangedFromIp;

    public function getId()
    {
        return $this-&gt;id;
    }

    public function setTitle($title)
    {
        $this-&gt;title = $title;
    }

    public function getTitle()
    {
        return $this-&gt;title;
    }

    public function setBody($body)
    {
        $this-&gt;body = $body;
    }

    public function getBody()
    {
        return $this-&gt;body;
    }

    public function getCreatedFromIp()
    {
        return $this-&gt;createdFromIp;
    }

    public function getUpdatedFromIp()
    {
        return $this-&gt;updatedFromIp;
    }

    public function getContentChangedFromIp()
    {
        return $this-&gt;contentChangedFromIp;
    }
}</code></pre>
<p><a name="document-mapping"></a></p>
<h2 id="iptraceable-document-example">IpTraceable Document example:</h2>
<pre><code class="language-php">&lt;?php
namespace Document;

use Gedmo\Mapping\Annotation as Gedmo;
use Doctrine\ODM\MongoDB\Mapping\Annotations as ODM;

/**
 * @ODM\Document(collection="articles")
 */
class Article
{
    /** @ODM\Id */
    private $id;

    /**
     * @ODM\String
     */
    private $title;

    /**
     * @var string $createdFromIp
     *
     * @ODM\String
     * @Gedmo\IpTraceable(on="create")
     */
    private $createdFromIp;

    /**
     * @var string $updatedFromIp
     *
     * @ODM\String
     * @Gedmo\IpTraceable
     */
    private $updatedFromIp;

    public function getId()
    {
        return $this-&gt;id;
    }

    public function setTitle($title)
    {
        $this-&gt;title = $title;
    }

    public function getTitle()
    {
        return $this-&gt;title;
    }

    public function getCreatedFromIp()
    {
        return $this-&gt;createdFromIp;
    }

    public function getUpdatedFromIp()
    {
        return $this-&gt;updatedFromIp;
    }
}</code></pre>
<p>Now on update and creation these annotated fields will be automatically updated</p>
<p><a name="yaml-mapping"></a></p>
<h2 id="yaml-mapping-example">Yaml mapping example:</h2>
<p>Yaml mapped Article: <strong>/mapping/yaml/Entity.Article.dcm.yml</strong></p>
<pre><code>---
Entity\Article:
  type: entity
  table: articles
  id:
    id:
      type: integer
      generator:
        strategy: AUTO
  fields:
    title:
      type: string
      length: 64
    createdFromIp:
      type: string
      length: 45
      nullable: true
      gedmo:
        ipTraceable:
          on: create
    updatedFromIp:
      type: string
      length: 45
      nullable: true
      gedmo:
        ipTraceable:
          on: update</code></pre>
<p><a name="xml-mapping"></a></p>
<h2 id="xml-mapping-example">Xml mapping example</h2>
<pre><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;doctrine-mapping xmlns="http://doctrine-project.org/schemas/orm/doctrine-mapping"
                  xmlns:gedmo="http://gediminasm.org/schemas/orm/doctrine-extensions-mapping"&gt;

    &lt;entity name="Mapping\Fixture\Xml\IpTraceable" table="ip-traceable"&gt;
        &lt;id name="id" type="integer" column="id"&gt;
            &lt;generator strategy="AUTO"/&gt;
        &lt;/id&gt;

        &lt;field name="createdFromIp" type="string", length="45", nullable="true"&gt;
            &lt;gedmo:ip-traceable on="create"/&gt;
        &lt;/field&gt;
        &lt;field name="updatedFromIp" type="string", length="45", nullable="true"&gt;
            &lt;gedmo:ip-traceable on="update"/&gt;
        &lt;/field&gt;
        &lt;field name="publishedFromIp" type="string" nullable="true", length="45"&gt;
            &lt;gedmo:ip-traceable on="change" field="status.title" value="Published"/&gt;
        &lt;/field&gt;

        &lt;many-to-one field="status" target-entity="Status"&gt;
            &lt;join-column name="status_id" referenced-column-name="id"/&gt;
        &lt;/many-to-one&gt;
    &lt;/entity&gt;

&lt;/doctrine-mapping&gt;</code></pre>
<p><a name="advanced-examples"></a></p>
<h2 id="advanced-examples">Advanced examples:</h2>
<h3 id="using-dependency-of-property-changes">Using dependency of property changes</h3>
<p>Add another entity which would represent Article Type:</p>
<pre><code class="language-php">&lt;?php
namespace Entity;

use Doctrine\ORM\Mapping as ORM;

/**
 * @ORM\Entity
 */
class Type
{
    /** @ORM\Id @ORM\GeneratedValue @ORM\Column(type="integer") */
    private $id;

    /**
     * @ORM\Column(length=128)
     */
    private $title;

    /**
     * @ORM\OneToMany(targetEntity="Article", mappedBy="type")
     */
    private $articles;

    public function getId()
    {
        return $this-&gt;id;
    }

    public function setTitle($title)
    {
        $this-&gt;title = $title;
    }

    public function getTitle()
    {
        return $this-&gt;title;
    }
}</code></pre>
<p>Now update the Article Entity to reflect publishedFromIp on Type change:</p>
<pre><code class="language-php">&lt;?php
namespace Entity;

use Gedmo\Mapping\Annotation as Gedmo;
use Doctrine\ORM\Mapping as ORM;

/**
 * @ORM\Entity
 */
class Article
{
    /** @ORM\Id @ORM\GeneratedValue @ORM\Column(type="integer") */
    private $id;

    /**
     * @ORM\Column(length=128)
     */
    private $title;

    /**
     * @var string $createdFromIp
     *
     * @Gedmo\IpTraceable(on="create")
     * @ORM\Column(length=45, nullable=true)
     */
    private $createdFromIp;

    /**
     * @var string $updatedFromIp
     *
     * @Gedmo\IpTraceable(on="update")
     * @ORM\Column(length=45, nullable=true)
     */
    private $updatedFromIp;

    /**
     * @ORM\ManyToOne(targetEntity="Type", inversedFromIp="articles")
     */
    private $type;

    /**
     * @var string $publishedFromIp
     *
     * @ORM\Column(nullable=true, length=45)
     * @Gedmo\IpTraceable(on="change", field="type.title", value="Published")
     */
    private $publishedFromIp;

    public function setType($type)
    {
        $this-&gt;type = $type;
    }

    public function getId()
    {
        return $this-&gt;id;
    }

    public function setTitle($title)
    {
        $this-&gt;title = $title;
    }

    public function getTitle()
    {
        return $this-&gt;title;
    }

    public function getCreatedFromIp()
    {
        return $this-&gt;createdFromIp;
    }

    public function getUpdatedFromIp()
    {
        return $this-&gt;updatedFromIp;
    }

    public function getPublishedFromIp()
    {
        return $this-&gt;publishedFromIp;
    }
}</code></pre>
<p>Yaml mapped Article: <strong>/mapping/yaml/Entity.Article.dcm.yml</strong></p>
<pre><code>---
Entity\Article:
  type: entity
  table: articles
  id:
    id:
      type: integer
      generator:
        strategy: AUTO
  fields:
    title:
      type: string
      length: 64
    createdFromIp:
      type: string
      length: 45
      nullable: true
      gedmo:
        ipTraceable:
          on: create
    updatedFromIp:
      type: string
      length: 45
      nullable: true
      gedmo:
        ipTraceable:
          on: update
    publishedFromIp:
      type: string
      length: 45
      nullable: true
      gedmo:
        ipTraceable:
          on: change
          field: type.title
          value: Published
  manyToOne:
    type:
      targetEntity: Entity\Type
      inversedBy: articles</code></pre>
<p>Now few operations to get it all done:</p>
<pre><code class="language-php">&lt;?php
$article = new Article;
$article-&gt;setTitle('My Article');

$em-&gt;persist($article);
$em-&gt;flush();
// article: $createdFromIp, $updatedFromIp were set

$type = new Type;
$type-&gt;setTitle('Published');

$article = $em-&gt;getRepository('Entity\Article')-&gt;findByTitle('My Article');
$article-&gt;setType($type);

$em-&gt;persist($article);
$em-&gt;persist($type);
$em-&gt;flush();
// article: $publishedFromIp, $updatedFromIp were set

$article-&gt;getPublishedFromIp(); // the IP that published this article</code></pre>
<p>Easy like that, any suggestions on improvements are very welcome</p>
<p><a name="traits"></a></p>
<h2 id="traits">Traits</h2>
<p>You can use IpTraceable traits for quick <strong>createdFromIp</strong> <strong>updatedFromIp</strong> string definitions
when using annotation mapping.
There is also a trait without annotations for easy integration purposes.</p>
<p><strong>Note:</strong> this feature is only available since php <strong>5.4.0</strong>. And you are not required
to use the Traits provided by extensions.</p>
<pre><code class="language-php">&lt;?php
namespace IpTraceable\Fixture;

use Gedmo\IpTraceable\Traits\IpTraceableEntity;
use Doctrine\ORM\Mapping as ORM;

/**
 * @ORM\Entity
 */
class UsingTrait
{
    /**
     * Hook ip-traceable behavior
     * updates createdFromIp, updatedFromIp fields
     */
    use IpTraceableEntity;

    /**
     * @ORM\Id
     * @ORM\GeneratedValue
     * @ORM\Column(type="integer")
     */
    private $id;

    /**
     * @ORM\Column(length=128)
     */
    private $title;
}</code></pre>
<p>The Traits are very simplistic - if you use different field names it is recommended to simply create your
own Traits specific to your project. The ones provided by this bundle can be used as example.</p>
<h2 id="example-of-implementation-in-symfony2">Example of implementation in Symfony2</h2>
<p>In your Sf2 application, declare an event subscriber that automatically set IP value on IpTraceableListener.</p>
<h3 id="code-of-subscriber-class">Code of subscriber class</h3>
<pre><code class="language-php">&lt;?php

namespace Acme\DemoBundle\EventListener;

use Symfony\Component\EventDispatcher\EventSubscriberInterface;
use Symfony\Component\HttpKernel\Event\GetResponseEvent;
use Symfony\Component\HttpKernel\KernelEvents;
use Symfony\Component\HttpFoundation\Request;

use Gedmo\IpTraceable\IpTraceableListener;

/**
 * IpTraceSubscriber
 */
class IpTraceSubscriber implements EventSubscriberInterface
{
    /**
     * @var Request
     */
    private $request;

    /**
     * @var IpTraceableListener
     */
    private $ipTraceableListener;

    public function __construct(IpTraceableListener $ipTraceableListener, Request $request = null)
    {
        $this-&gt;ipTraceableListener = $ipTraceableListener;
        $this-&gt;request = $request;
    }

    /**
     * Set the username from the security context by listening on core.request
     *
     * @param GetResponseEvent $event
     */
    public function onKernelRequest(GetResponseEvent $event)
    {
        if (null === $this-&gt;request) {
            return;
        }

        // If you use a cache like Varnish, you may want to set a proxy to Request::getClientIp() method
        // $this-&gt;request-&gt;setTrustedProxies(array('127.0.0.1'));

        // $ip = $_SERVER['REMOTE_ADDR'];
        $ip = $this-&gt;request-&gt;getClientIp();

        if (null !== $ip) {
            $this-&gt;ipTraceableListener-&gt;setIpValue($ip);
        }
    }

    public static function getSubscribedEvents()
    {
        return array(
            KernelEvents::REQUEST =&gt; 'onKernelRequest',
        );
    }
}
</code></pre>
<h3 id="configuration-for-servicesxml">Configuration for services.xml</h3>
<pre><code class="language-xml">&lt;?xml version="1.0" ?&gt;

&lt;container xmlns="http://symfony.com/schema/dic/services"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://symfony.com/schema/dic/services http://symfony.com/schema/dic/services/services-1.0.xsd"&gt;

    &lt;parameters&gt;
        &lt;parameter key="alterphp_doctrine_extensions.event_listener.ip_trace.class"&gt;Acme\DemoBundle\EventListener\IpTraceListener&lt;/parameter&gt;
    &lt;/parameters&gt;

    &lt;services&gt;

        ...

        &lt;service id="gedmo_doctrine_extensions.listener.ip_traceable" class="Gedmo\IpTraceable\IpTraceableListener" public="false"&gt;
            &lt;tag name="doctrine.event_subscriber" connection="default" /&gt;
            &lt;call method="setAnnotationReader"&gt;
                &lt;argument type="service" id="annotation_reader" /&gt;
            &lt;/call&gt;
        &lt;/service&gt;

        &lt;service id="alterphp_doctrine_extensions.event_listener.ip_trace" class="%alterphp_doctrine_extensions.event_listener.ip_trace.class%" public="false" scope="request"&gt;
            &lt;argument type="service" id="gedmo_doctrine_extensions.listener.ip_traceable" /&gt;
            &lt;argument type="service" id="request" on-invalid="null" /&gt;
            &lt;tag name="kernel.event_subscriber" /&gt;
        &lt;/service&gt;

    &lt;/services&gt;
&lt;/container&gt;
</code></pre>
                    </div>

                    <footer>
                        <hr/>
                                                    <div role="contentinfo">
                                <p>
                                    Find Doctrine Extensions 3.0.0 on <a href="https://github.com/Atlantic18/DoctrineExtensions">GitHub</a>.
                                </p>
                            </div>
                                                Built with <a href="http://couscous.io/">Couscous</a> using a <a href="https://github.com/CouscousPHP/Template-ReadTheDocs">theme</a> based on <a href="https://readthedocs.org/">Read the Docs</a>.
                    </footer>

                </div>
            </div>

        </section>

    </div>

    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
    <script src="http://Atlantic18.github.io/DoctrineExtensions/js/theme.js"></script>

    <script>
        $(function() {
            // Syntax highlighting
            hljs.initHighlightingOnLoad();
        });
    </script>

</body>
</html>
